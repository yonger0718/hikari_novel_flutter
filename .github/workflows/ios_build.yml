name: Build iOS IPA

on:
  push:
    branches: [ "feature/cf-challenge" ]
  workflow_dispatch: # 允許手動點擊執行

jobs:
  build_ios:
    name: Build IPA
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Install Dependencies
        run: flutter pub get

      - name: Patch iOS Config
        run: |
          # 修正 Info.plist (移除名稱中的底線以解決 Error 35)
          sed -i '' 's/hikari_novel_flutter/HikariNovel/g' ios/Runner/Info.plist
          
          # 修正 Bundle ID (避免使用 com.example 佔位符)
          sed -i '' 's/com.example.hikariNovelFlutter/pers.cyh128.hikariNovel/g' ios/Runner.xcodeproj/project.pbxproj
          
          # 修正 Product Name (確保內部名稱一致且無底線)
          sed -i '' 's/PRODUCT_NAME = "$(TARGET_NAME)";/PRODUCT_NAME = HikariNovel;/g' ios/Runner.xcodeproj/project.pbxproj

      - name: Build iOS (No Codesign)
        run: flutter build ios --release --no-codesign

      - name: Create IPA
        run: |
          cd build/ios/iphoneos
          mkdir -p Payload
          mv HikariNovel.app Payload
          zip -qq -r -9 hikari_novel_flutter.ipa Payload

      - name: Upload IPA to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: hikari-novel-ipa
          path: build/ios/iphoneos/hikari_novel_flutter.ipa
